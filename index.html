<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISA 배당 엔진 v3.7 Stable</title>

  <!-- CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
    body { font-family: 'Noto Sans KR', sans-serif; background:#f8fafc; }
    aside { transition: transform .3s ease }
    aside.active { transform: translateX(0) }
    #sidebar-overlay.active { display:block }
    .card-shadow { box-shadow:0 4px 12px rgba(0,0,0,.06) }
    .sync-spin { animation: spin 1.2s linear infinite }
    @keyframes spin { to { transform:rotate(360deg) } }
  </style>
</head>

<body class="min-h-screen text-slate-800">

<div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/40 z-40" onclick="toggleSidebar()"></div>

<!-- SIDEBAR -->
<aside id="sidebar" class="fixed z-50 w-64 h-full bg-slate-900 text-slate-200 -translate-x-full md:translate-x-0">
  <div class="p-6 border-b border-slate-800">
    <h1 class="text-white font-black text-xl">ISA ENGINE</h1>
    <p class="text-xs text-slate-400">v3.7 Stable</p>
  </div>

  <nav class="p-4 space-y-2">
    <button onclick="show('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-lg bg-blue-600 text-white font-bold">
      <i class="fa-solid fa-house mr-2"></i> 대시보드
    </button>
    <button onclick="show('history')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800">
      <i class="fa-solid fa-list mr-2"></i> 거래 내역
    </button>
    <button onclick="show('add')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800">
      <i class="fa-solid fa-plus mr-2"></i> 거래 입력
    </button>
  </nav>

  <div class="p-4">
    <input id="sheetUrl" placeholder="Google Sheet CSV URL"
      class="w-full p-2 rounded bg-slate-800 text-xs text-slate-300 border border-slate-700"/>
    <button onclick="saveSheet()"
      class="mt-2 w-full py-2 text-xs font-bold rounded bg-blue-600/20 text-blue-400">
      연동 / 갱신
    </button>
  </div>
</aside>

<!-- MAIN -->
<main class="md:ml-64 p-6 space-y-8">

<!-- HEADER -->
<header class="flex justify-between items-center">
  <button onclick="toggleSidebar()" class="md:hidden w-10 h-10 bg-white rounded shadow">
    <i class="fa-solid fa-bars"></i>
  </button>
  <h2 class="text-3xl font-black">포트폴리오 대시보드</h2>
  <button onclick="sync()" class="px-4 py-2 bg-red-600 text-white rounded font-bold">
    <i id="syncIcon" class="fa-solid fa-rotate"></i> 동기화
  </button>
</header>

<!-- STATS -->
<section class="grid grid-cols-1 md:grid-cols-4 gap-4">
  <div class="bg-white p-6 rounded-2xl card-shadow">
    <p class="text-xs text-slate-400">총 자산</p>
    <p id="totalValue" class="text-2xl font-black">₩0</p>
  </div>
  <div class="bg-white p-6 rounded-2xl card-shadow">
    <p class="text-xs text-slate-400">투자 원금</p>
    <p id="invested" class="text-2xl font-black">₩0</p>
  </div>
  <div class="bg-white p-6 rounded-2xl card-shadow">
    <p class="text-xs text-slate-400">재투자</p>
    <p id="reinvest" class="text-2xl font-black text-emerald-600">₩0</p>
  </div>
  <div class="bg-white p-6 rounded-2xl card-shadow">
    <p class="text-xs text-slate-400">월 배당</p>
    <p id="monthlyDiv" class="text-2xl font-black text-blue-600">₩0</p>
  </div>
</section>

<!-- CHART -->
<section class="bg-white p-8 rounded-3xl card-shadow">
  <h3 class="font-black mb-4">자산 비중</h3>
  <canvas id="chart" height="120"></canvas>
</section>

<!-- HOLDINGS -->
<section class="bg-white rounded-3xl card-shadow overflow-hidden">
  <div class="p-6 border-b">
    <h3 class="font-black">보유 종목</h3>
  </div>
  <table class="w-full text-sm">
    <thead class="bg-slate-50 text-slate-400">
      <tr>
        <th class="p-4 text-left">종목</th>
        <th class="p-4">수량</th>
        <th class="p-4">평단</th>
        <th class="p-4">평가금</th>
        <th class="p-4">월배당</th>
      </tr>
    </thead>
    <tbody id="holdings"></tbody>
  </table>
</section>

</main>

<script>
/* ========= CORE ========= */
const TAX = 0.154
let tx = JSON.parse(localStorage.getItem("tx")) || []
let market = JSON.parse(localStorage.getItem("market")) || {}
let chart

function toggleSidebar(){
  document.getElementById("sidebar").classList.toggle("active")
  document.getElementById("sidebar-overlay").classList.toggle("active")
}

function show(){}

/* ========= SHEET ========= */
async function sync(){
  const icon = document.getElementById("syncIcon")
  icon.classList.add("sync-spin")
  const url = localStorage.getItem("sheetUrl")
  if(!url){ icon.classList.remove("sync-spin"); return }

  const res = await fetch("https://api.allorigins.win/get?url="+encodeURIComponent(url))
  const txt = (await res.json()).contents
  txt.split("\n").forEach(r=>{
    const c=r.split(",")
    if(c.length>=2 && !isNaN(c[0])){
      market[c[0]]={ price:+c[1], yield:+(c[2]||0), name:c[3]||c[0] }
    }
  })
  localStorage.setItem("market",JSON.stringify(market))
  render()
  icon.classList.remove("sync-spin")
}

function saveSheet(){
  localStorage.setItem("sheetUrl",document.getElementById("sheetUrl").value.trim())
  sync()
}

/* ========= RENDER ========= */
function render(){
  let total=0, invested=0, reinvest=0, monthly=0
  const map={}

  tx.forEach(t=>{
    const v=t.qty*t.price
    if(!map[t.ticker]) map[t.ticker]={...t, qty:0, cost:0}
    map[t.ticker].qty+=t.qty
    map[t.ticker].cost+=v
    t.cat==="3"? reinvest+=v: invested+=v
  })

  const tbody=document.getElementById("holdings")
  tbody.innerHTML=""

  Object.values(map).forEach(h=>{
    const m=market[h.ticker]||{}
    const price=m.price||h.price
    const val=h.qty*price
    const md=val*((m.yield||h.yield)/100/12)
    total+=val; monthly+=md

    tbody.innerHTML+=`
      <tr class="border-t">
        <td class="p-4">${h.name}<div class="text-xs text-slate-400">${h.ticker}</div></td>
        <td class="p-4 text-center">${h.qty}</td>
        <td class="p-4 text-center">₩${Math.round(h.cost/h.qty)}</td>
        <td class="p-4 text-center">₩${Math.round(val)}</td>
        <td class="p-4 text-center text-blue-600">₩${Math.round(md)}</td>
      </tr>`
  })

  document.getElementById("totalValue").innerText=`₩${Math.round(total)}`
  document.getElementById("invested").innerText=`₩${Math.round(invested)}`
  document.getElementById("reinvest").innerText=`₩${Math.round(reinvest)}`
  document.getElementById("monthlyDiv").innerText=`₩${Math.round(monthly*(1-TAX))}`

  if(chart) chart.destroy()
  chart=new Chart(document.getElementById("chart"),{
    type:"doughnut",
    data:{labels:Object.keys(map),
      datasets:[{data:Object.values(map).map(h=>market[h.ticker]?.price*h.qty||0)}]},
    options:{cutout:"75%"}
  })
}

render()
</script>
</body>
</html>
